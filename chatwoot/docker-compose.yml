version: "3.9"

services:
  chatwoot-postgres:
    image: pgvector/pgvector:pg15
    container_name: chatwoot-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    networks:
      - chatwoot-net

  chatwoot-redis:
    image: redis:7-alpine
    container_name: chatwoot-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ./redis_data:/data
    networks:
      - chatwoot-net

  rails:
    image: chatwoot/chatwoot:v4.7.0
    container_name: chatwoot-rails
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      - chatwoot-postgres
      - chatwoot-redis
    networks:
      - chatwoot-net
      - proxy-net

  sidekiq:
    image: chatwoot/chatwoot:v4.7.0
    container_name: chatwoot-sidekiq
    restart: unless-stopped
    command: bundle exec sidekiq
    env_file:
      - .env
    depends_on:
      - chatwoot-postgres
      - chatwoot-redis
    networks:
      - chatwoot-net

networks:
  chatwoot-net:
    driver: bridge
  proxy-net:
    external: true
